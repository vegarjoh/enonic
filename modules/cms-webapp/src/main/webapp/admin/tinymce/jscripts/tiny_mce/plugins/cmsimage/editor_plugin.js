(function(){tinymce.PluginManager.requireLangPack("cmsimage");var e=/_image\/(\d+)/im;tinymce.create("tinymce.plugins.CMSImagePlugin",{init:function(t,n){var r=this;t.addCommand("cmsimage",function(){var r="adminpage?page=600&op=popup&subop=insert"+"&selectedunitkey=-1"+"&fieldname=null"+"&fieldrow=null"+"&handler=com.enonic.vertical.adminweb.handlers.ContentEnhancedImageHandlerServlet"+"&contenthandler=image";var i=t.dom;var s=t.selection;var o=s.getNode();var u;if(o.nodeName==="IMG"){if(i.getAttrib(o,"src").match(e)){u=i.getAttrib(o,"src").match(e)[1];r="adminpage?page=992&key="+u+"&cat=-1&op=insert&subop=update"}}t.windowManager.open({file:r,width:990+t.getLang("cmsimage.delta_width",0),height:620+t.getLang("cmsimage.delta_height",0),inline:1,scrollbars:"yes"},{plugin_url:n})});t.addButton("cmsimage",{title:"cmsimage.desc",cmd:"cmsimage",image:n+"/img/image.gif"});t.onKeyUp.add(function(e,t){if(t.keyCode===13){var n=e.dom;var r=e.selection;var i=r.getNode();var s=n.hasClass(i,"editor-p-block")||n.hasClass(i,"editor-p-center");if(s){n.removeClass(i,"editor-p-block");n.removeClass(i,"editor-p-center")}}});t.onNodeChange.add(function(t,n,r){var i=t.dom;var s=r.parentNode;var o=r.nodeName=="IMG"&&i.getAttrib(r,"src").match(e)&&r.className.indexOf("mceItem")==-1;var u=r.nodeName=="IMG"&&i.hasClass(r,"editor-image-left")||i.getStyle(r,"textAlign")=="left";var a=r.nodeName=="IMG"&&i.hasClass(r,"editor-image-right")||i.getStyle(r,"textAlign")=="right";var f=i.hasClass(s,"editor-p-center")||i.getStyle(r,"textAlign")=="center";var l=i.hasClass(s,"editor-p-block")||i.getStyle(r,"textAlign")=="justify";n.setActive("cmsimage",o);n.setActive("justifyleft",u);n.setActive("justifyright",a);n.setActive("justifycenter",f);n.setActive("justifyfull",l)});var i=null;t.onMouseDown.add(function(e,t){if(!tinymce.isGecko){var n=e.dom;if(t.target.nodeName==="IMG"){i=t.target;var r=t.target.parentNode;if(r.nodeName==="P"&&(n.hasClass(r,"editor-p-block")||n.hasClass(r,"editor-p-center"))){e.selection.select(r)}}}});t.onMouseUp.add(function(e,t){if(!tinymce.isGecko){var n=e.dom;if(t.target.nodeName==="IMG"){i=t.target;var r=t.target.parentNode;if(r.nodeName==="P"&&(n.hasClass(r,"editor-p-block")||n.hasClass(r,"editor-p-center"))){e.selection.select(t.target)}}}});t.onBeforeExecCommand.add(function(e,t,n,s){if(t==="JustifyLeft"||t==="JustifyRight"||t==="JustifyCenter"||t==="JustifyFull"){var o=e.dom;if(tinymce.isGecko)i=e.selection.getNode();if(i&&i.nodeName==="IMG"){r.removeCmsCssFromImage(e.selection.getNode(),e);o.setAttrib(i,"data-cms-image","1");if(t==="JustifyCenter"&&o.hasClass(i.parentNode,"editor-p-block")){o.setAttrib(i.parentNode,"data-cms-p-block","1")}}}});t.onExecCommand.add(function(e,t,n,s){if(!/Justify(left|right|center|full)/i.test(t)){return}var o=e.dom;var u=o.select("img[data-cms-image=1]")[0];if(u&&u.nodeName==="IMG"){if(t==="JustifyLeft"){r.alignImage(e,u,"left")}else if(t==="JustifyRight"){r.alignImage(e,u,"right")}else if(t==="JustifyCenter"){r.centerImage(e,u);var a=o.select("p[data-cms-p-block=1]")[0];if(o.hasClass(a,"editor-p-block")){o.remove(a)}}else if(t==="JustifyFull"){r.blockImage(e,u)}e.execCommand("mceRepaint");u=o.select("img[data-cms-image=1]")[0];o.setAttrib(u,"data-cms-image");e.selection.select(u);o.setAttrib(u,"_moz_resizing","true");i=u}})},createControl:function(e,t){return null},getInfo:function(){return{longname:"Image Browser for CMS",author:"Enonic",authorurl:"http://www.enonic.com",infourl:"http://www.enonic.com",version:"0.2"}},alignImage:function(e,t,n){var r=this;var i=e.dom;var s=i.getParent(t,"p");var o=t.parentNode.nodeName==="A";var u,a,f;i.setStyle(t,"float","");i.addClass(t,"editor-image-"+n);if(o){i.removeClass(t.parentNode,"editor-image-left");i.removeClass(t.parentNode,"editor-image-right")}u=s&&s.nodeName==="P"&&(i.hasClass(s,"editor-p-block")||i.hasClass(s,"editor-p-center"));if(u){i.remove(s,true)}else{return}a=o?r.getNextSiblingElement(t.parentNode):r.getNextSiblingElement(t);f=a&&a.nodeName==="P";if(!f){a=o?r.getPrevSiblingElement(t.parentNode):r.getPrevSiblingElement(t)}if(a&&a.nodeName==="P"){var l=null;if(o){l=t.parentNode;r.prependChild(a,l.cloneNode(true))}else{l=t;r.prependChild(a,l.cloneNode(false))}i.remove(l,false)}else{var c=new tinymce.dom.Serializer(e.settings,e.dom);var h=o?c.serialize(t.parentNode):c.serialize(t);var p=o?t.parentNode:t;e.selection.setContent("<p>"+h+"<br/></p>");i.remove(p,false)}},blockImage:function(e,t){var n=e.dom;var r=n.getParent(t,"p");var i=t.parentNode.nodeName==="A";var s,o;var u;n.setStyle(r,"textAlign","");n.setStyle(t,"display","");n.setStyle(t,"marginLeft","");n.setStyle(t,"marginRight","");n.removeClass(t,"editor-img-left");n.removeClass(t,"editor-img-right");s=r&&r.nodeName==="P"&&n.hasClass(r,"editor-p-block");if(s){return}o=r&&r.nodeName==="P"&&n.hasClass(r,"editor-p-center");if(o){n.removeClass(r,"editor-p-center");n.addClass(r,"editor-p-block");return}var a=n.getParent(t,n.isBlock);var f;if(!a||a.childNodes.length>=1){f=n.create("p",{"class":"editor-p-block"});if(i){u=t.parentNode;f.appendChild(u.cloneNode(true))}else{u=t;f.appendChild(u.cloneNode(false))}a.parentNode.insertBefore(f,a);n.remove(u);t=f.firstChild;a=f}},centerImage:function(e,t){var n=this,r=e.dom;var i=r.getParent(t,"p");var s=t.parentNode.nodeName==="A";r.setStyle(i,"textAlign","");r.setStyle(t,"display","");r.setStyle(t,"marginLeft","");r.setStyle(t,"marginRight","");r.removeClass(t,"editor-img-left");r.removeClass(t,"editor-img-right");var o=i&&r.hasClass(i,"editor-p-center");if(o){return}var u=i&&r.hasClass(i,"editor-p-block");if(u){r.removeClass(i,"editor-p-block");r.addClass(i,"editor-p-center");return}var a=r.create("p",{"class":"editor-p-center"});var f=t.cloneNode(true);r.add(a,f);var l=n.getPrevSiblingElement(i);if(l&&l.nodeName==="P"){r.insertAfter(a,l)}else{var c=n.getNextSiblingElement(i);i.parentNode.insertBefore(a,i)}r.remove(t)},getPrevSiblingElement:function(e){var t=e?e.previousSibling:null;if(t){while(t&&t.nodeType!=1){t=t.previousSibling}}return t},getNextSiblingElement:function(e){var t=e?e.nextSibling:null;if(t){while(t&&t.nodeType!=1){t=t.nextSibling}}return t},prependChild:function(e,t){e.insertBefore(t,e.firstChild)},removeCmsCssFromImage:function(e,t){var n=t.dom;n.removeClass(e,"editor-image-left");n.removeClass(e,"editor-image-right")}});tinymce.PluginManager.add("cmsimage",tinymce.plugins.CMSImagePlugin)})()