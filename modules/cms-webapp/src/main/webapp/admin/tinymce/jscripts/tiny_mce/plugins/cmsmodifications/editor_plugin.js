(function(){tinymce.create('tinymce.plugins.CMSModifications',{init:function(ed,url){var t=this;ed.onBeforeSetContent.add(function(ed,o){t._removeEncodedCdataTags(o);t._fixHtmlKludgesBeforeContentIsSet(o)});ed.onGetContent.add(function(ed,o){t._fixHtmlKludgesOnGetContent(o)});ed.onBeforeGetContent.add(function(ed,o){t._cleanPreTag(ed)});ed.onPostRender.add(function(ed,cm){t._addHtmlAndFullScreenButton(ed,cm)});if(tinymce.isIE||tinymce.isWebKit){ed.onKeyDown.add(function(ed,e){var selection=ed.selection;var selectedNodeIsPreElementAndKeyboardKeyIsEnter=selection.getNode().nodeName=='PRE'&&e.keyCode==13;if(selectedNodeIsPreElementAndKeyboardKeyIsEnter){selection.setContent('<br id="__" />&nbsp;',{format:'raw'});var n=ed.dom.get('__');n.removeAttribute('id');selection.select(n);selection.collapse();return tinymce.dom.Event.cancel(e)}})}},getInfo:function(){return{longname:'CMS Modifications',author:'tan@enonic.com',authorurl:'http://www.enonic.com',infourl:'http://www.enonic.com',version:"1.0"}},_addHtmlAndFullScreenButton:function(ed,cm){if(ed.settings.readonly){return}var editorId=ed.id;var pathRow=document.getElementById(editorId+'_path_row');var statusBar=pathRow.parentNode;pathRow.style.padding='3px 0 0 0';statusBar.style.height='26px';var buttons='';if(ed.settings.accessToHtmlSource){buttons+='<a class="mceButton mceButtonEnabled cms_code" title="'+ed.getLang('advanced.code_desc')+'" '+'onclick="javascript:tinyMCE.get(\''+editorId+'\').execCommand(\'mceCodeEditor\',false); return false;" '+'onmousedown="return false;" href="javascript:;" '+'style="float:left"><span class="mceIcon cms_code"></span></a>'}buttons+='<a class="mceButton mceButtonEnabled mce_fullscreen" '+'title="'+ed.getLang('fullscreen.desc')+'" onclick="javascript:tinyMCE.get(\''+editorId+'\').execCommand(\'mceFullScreen\',false); return false;" '+'href="javascript:;" style="float:left"><span class="mceIcon mce_fullscreen"></span></a><span class="mceSeparator" style="float:left"></span>';var buttonWrapper=document.createElement('div');buttonWrapper.id=editorId+'_cms_button_wrapper';buttonWrapper.style.cssFloat='left';buttonWrapper.innerHTML=buttons;statusBar.insertBefore(buttonWrapper,pathRow)},_removeEncodedCdataTags:function(options){options.content=options.content.replace(/\/\/ &lt;!\[CDATA\[/gim,'');options.content=options.content.replace(/\/\/ ]]&gt;/gim,'')},_fixHtmlKludgesBeforeContentIsSet:function(options){options.content=options.content.replace(/<script\s+(.+)\/>/g,'<script $1><\/script>');options.content=options.content.replace(/<td\/>/g,'<td>&nbsp;<\/td>');options.content=options.content.replace(/<textarea\s+(.+)\/>/g,'<textarea $1><\/textarea>');options.content=options.content.replace(/<label\s+(.+)\/>/g,'<label $1><\/label>');options.content=options.content.replace(/<img\s+(.+)\/>/g,'<img $1 _moz_dirty="" \/>');options.content=options.content.replace(/<embed(.+\n).+\/>/g,'<embed$1>.</embed>')},_fixHtmlKludgesOnGetContent:function(options){options.content=options.content.replace(/<iframe(.+?)>(|\s+)<\/iframe>/g,'<iframe$1>cms_content<\/iframe>');options.content=options.content.replace(/<video(.+?)>(|\s+)<\/video>/g,'<video$1>cms_content<\/video>');options.content=options.content.replace(/<td><\/td>/g,'<td>&nbsp;</td>');options.content=options.content.replace(/<th><\/th>/g,'<th>&nbsp;</th>')},_cleanPreTag:function(ed){var pre=ed.dom.select('pre');tinymce.each(pre,function(el){var cn=el.childNodes,n;for(var i=0;i<cn.length;i++){n=cn[i];if(n.nodeValue){n.nodeValue=n.nodeValue.replace(/\xA0/gm,' ')}}});var br=ed.dom.select('pre br');for(var i=0;i<br.length;i++){var nlChar;if(tinymce.isIE){nlChar='\r\n'}else{nlChar='\n'}var nl=ed.getDoc().createTextNode(nlChar);ed.dom.insertAfter(nl,br[i]);ed.dom.remove(br[i])}}});tinymce.PluginManager.add('cmsmodifications',tinymce.plugins.CMSModifications)})();